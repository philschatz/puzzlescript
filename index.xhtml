<html xmlns="http://www.w3.org/1999/xhtml">

<head>
    <title>Example Puzzlescript Games using HTML Tables</title>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <script src="./lib/puzzlescript.js"></script>
    <link rel="stylesheet" href="./style.css"/>
    <style>
        body { font-family: helvetica, arial, sans-serif; }
        .hidden { display: none; }
        .light { opacity: .5 }
        kbd {
            font: 11px "SFMono-Regular",Consolas,"Liberation Mono",Menlo,Courier,monospace;
            display: inline-block;
            padding: 3px 5px;
            font-size: 11px;
            line-height: 10px;
            color: #444d56;
            vertical-align: middle;
            background-color: #fafbfc;
            border: solid 1px #c6cbd1;
            border-bottom-color: #959da5;
            border-radius: 3px;
            box-shadow: inset 0 -1px 0 #959da5;
        }

        /* Decide whether to move the following (all) to the html-table.css file */

        /* When the CSS is disabled then show a plain table with borders */
        .ps-table.ps-ui-disabled {
            width: 100%;
        }
        .ps-table.ps-ui-disabled td {
            border: 1px solid #ccc;
        }

        /* When the CSS is disabled, still mark the player cell in bold */
        table.ps-table .ps-cell-label.ps-player {
            font-weight: bold;
        }

        #gamepadIcon:not(.enabled) {
            filter: grayscale(100%);
            opacity: .5;
        }

    </style>
</head>

<body>
    <h1>Example <a href="https://github.com/philschatz/puzzlescript">PuzzleScript Games</a> using HTML Tables</h1>

    <p><input id="disableCss" type="checkbox"/> <label for="disableCss"><strong>Check</strong> to see what a non-sighted user would experience (disables CSS)</label></p>

    <p><label for="gameSelection">Currently playing:</label>
        <select id="gameSelection">
            <option disabled="disabled">--- Works Well Now ---</option>
            <option value="gist-f0b9b8e95d0bc87c9fb9e411756daa23">IceCrates⁣</option>
            <option value="gist-7f4470ab80d9f7ffe4b9e28c83b26adc">PUSH⁣</option>
            <option value="pot-wash-panic_itch">Pot Wash Panic</option>
            <option value="gist-457c6d8be68ffb6d921211d40ca48c15">Pants, Shirt, Cap⁣</option>
            <option value="gist-e13482e035a5f75e9b0e4d0b5f28f8b6">Pushcat Jr⁣</option>
            <!-- <option value="gist-a4829564ab394e720a82cf25d6c9cd91">Garten der Medusen⁣</option> -->
            <option value="separation_itch">Separation⁣</option>
            <option value="roll-those-sixes-itch">Roll those Sixes⁣</option>
            <option value="gist-6daa8b63cf79202cd085c1b168048c09">Rock, Paper, Scissors (v0.90 = v1.alpha)⁣</option>
            <option value="gist-c5ec035de4e0c145a85327942fb76098">Some lines were meant to be crossed⁣</option>
            <option value="sleepy-player_itch">Sleepy players⁣</option>


            <option disabled="disabled">--- Works but are a little too verbose ---</option>
            <option value="skipping-stones_d6fd6fcf84de185e2584">Skipping Stones to Lonely Homes⁣</option>
            <option value="gist-8074d60a0af768f970ef055d4460414d">Bubble Butler: CMD REORGANIZE⁣</option>
            <option value="gist-ee39bfe12012c774acfc5e3d32fb4f89">Boxes &amp; Balloons⁣</option>
            <option value="mirror-isles_219a7db6511dad557b84">Mirror Isles⁣</option>
            <option value="gist-e86e1d6cf24307499c1cd1aaaa733a91">SwapBot⁣</option>
            <option value="spikes-n-stuff_dc5c4a669e362e389e994025075f7d0b">Spikes 'n' Stuff⁣</option>

            <option disabled="disabled">--- Works but have more animation messages than needed ---</option>
            <option value="spacekoban_6a6c07f71d7039e4155e">Spacekoban⁣</option>
            <option value="gist-181f370a15625905ca6e844a972a4abf">Miss Direction⁣</option>
            <option value="gist-711d6220e4fe2a36254cc544c6ba4885">Memories Of Castlemouse⁣</option>
            <option value="rosden.itch.io_islands">Islands⁣</option>
            <option value="rosden.itch.io_bomb-n-ice">bomb n ice⁣</option>

            <option disabled="disabled">--- Works but have many animation messages ---</option>
            <option value="cyber-lasso-e3e444f7c63fb21b6ec0">Cyber-Lasso⁣</option>
            <option value="boxes-love-bloxing_c2d717a77f9aa02ecb1b793111f3a921">Boxes Love Bloxing Gloves⁣</option>
            <option value="hack-the-net_8b5eb39cb825277832d261b3142f084b">Hack the Net⁣</option>
            <option value="spooky-pumpkin_7242443">Spooky Pumpkin Game⁣</option>

            <option value="alien-disco_itch">Alien Disco⁣</option>
            <option value="gist-b6c8ba9363b4cca270d8ce5e88f79abf">Vacuum⁣</option>
            <option value="gist-542b97948cb1d377dce6d276c0bcd9d5">Sokoboros⁣</option>
            <option value="gist-2b9ece642cd7cdfb4a5f2c9fa8455e40">Beam Islands⁣</option>
            <option value="entanglement">Entanglement - Chapter One⁣</option>
        </select>

        <span id="loadingIndicator" class="hidden">Loading...</span>
    </p>
    
    <table id="theGame" aria-labelledby="gameInstructions">
        <caption>
            Game info goes here. like the current level, the goal, etc.
            <!-- See https://developer.mozilla.org/en-US/docs/Web/Accessibility/ARIA/ARIA_Live_Regions -->
            <div role="log" aria-live="polite">The Game log</div>
        </caption>
    </table>


    <div id="gameInstructions">
        <p>To play:</p>
        <ul>
            <li>Arrow keys or <kbd>W</kbd>, <kbd>S</kbd>, <kbd>A</kbd>, <kbd>D</kbd></li>
            <li><kbd>X</kbd> for Action</li>
            <li><kbd>Z</kbd> or <kbd>U</kbd> for Undo</li>
            <li><kbd>R</kbd> to Restart the current level</li>
        </ul>
    </div>

    <p>
        <img id="gamepadIcon" alt="gamepad icon" width="42" height="42" src="./gamepad-icon.svg"/>
        <span id="gamepadDisabled" class="hidden"><strong>Tip:</strong> Connect a gamepad controller (XBOX/PS3/PS4/etc) to use it to play games. You might need to press some buttons so it is detected. Occasionally, a driver needs to be installed.</span>
        <span id="gamepadRecognized" class="hidden">Gamepad is detected. You can play using it now. Just make sure the game is focused.</span>
        <span id="gamepadNotRecognized" class="hidden">Gamepad is detected but not recognized. Please submit an Issue on the Repository and we will help get it added</span>
    </p>
    
    <p><a href="https://github.com/philschatz/puzzlescript">Source On GitHub</a></p>

    <script type="text/javascript">//<![CDATA[
        const table = document.querySelector('#theGame')
        const gameSelection = document.querySelector('#gameSelection')
        const loadingIndicator = document.querySelector('#loadingIndicator')
        let gameId // used for loading and saving game progress

        // Save when the user completes a level
        const handler = {
            onLevelChange: function (newLevelNum) {
                // Hide the Loading text because the level loaded
                loadingIndicator.classList.add('hidden')
                gameSelection.removeAttribute('disabled')

                setStorage(gameId, newLevelNum)
            }
        }


        function startTableEngine(webworkerUrl) {

            const worker = new Worker(webworkerUrl)
            const tableEngine = new window.PuzzleScript.WebworkerTableEngine(worker, table, handler)
            // const tableEngine = new window.PuzzleScript.SyncTableEngine(table, handler)

            startGamepadDetection(tableEngine)
            playSelectedGame(tableEngine)

            // Load the new game when the dropdown changes
            gameSelection.addEventListener('change', function () { playSelectedGame(tableEngine)})
        }


        let cacheApi
        if (window.caches) {
            cacheApi = window.caches
        } else {
            // In-memory polyfill for browsers that do not support https://developer.mozilla.org/en-US/docs/Web/API/Cache
            const memCaches = new Map()
            class InMemoryCache {
                constructor() { this.map = new Map() }
                put(request, response) { this.map.set(request.url, response.clone()) }
                match(request) { return this.map.get(request.url) }
            }
            cacheApi = {
                open: function (cacheName) {
                    let ret = memCaches.get(cacheName) || new InMemoryCache()
                    memCaches.add(ret)
                    return Promise.resolve(ret)
                }
            }
        }

        // From https://stackoverflow.com/a/39367408
        const CACHE_NAME = 'puzzlescript'
        function cacheFetch(url, options) {
            const request = new Request(url, options)
            const requestURL = new URL(request.url)
            const freshResource = fetch(request).then(function (response) {
                const clonedResponse = response.clone()
                // Don't update the cache with error pages!
                if (response.ok) {
                    // All good? Update the cache with the network response
                    caches.open(CACHE_NAME).then(function (cache) {
                        cache.put(request, clonedResponse)
                    })
                }
                return response
            })
            const cachedResource = caches.open(CACHE_NAME).then(function (cache) {
                return cache.match(request).then(function(response) {
                    return response || freshResource
                })
            }).catch(function (e) {
                return freshResource
            })
            return cachedResource
        }

        function playSelectedGame(tableEngine) {
            loadingIndicator.classList.remove('hidden') // Show the "Loading..." text
            gameSelection.setAttribute('disabled', 'disabled')

            gameId = gameSelection.value
            cacheFetch(`./games/${gameId}/script.txt`, {redirect: 'follow'})
            .then(resp => {
                if (resp.ok) {
                    return resp.text().then(function(source) {
                        // Load the game
                        tableEngine.setGame(source, getStorage(gameId) || 0)
                    })
                } else {
                    alert('Problem finding game game file. Please choose another one')
                    loadingIndicator.classList.add('hidden')
                    gameSelection.removeAttribute('disabled')
                }
            },
            err => {
                alert('Could not download the game. Are you connected to the internet?')
                loadingIndicator.classList.add('hidden')
                gameSelection.removeAttribute('disabled')
            })
        }

        


        // gh-pages does not allow hosting large JavaScript files so we need to load the webworker from unpkg.com
        if (window.location.host === 'philschatz.com') {
            loadRemoteWebworker('https://unpkg.com/puzzlescript@5/lib/puzzlescript-webworker.js', startTableEngine)
        } else {
            startTableEngine('./lib/puzzlescript-webworker.js')
        }

        // Show/hide the "Add controller" message if a Gamepad is attached
        const gamepadIcon = document.querySelector('#gamepadIcon')
        const gamepadDisabled = document.querySelector('#gamepadDisabled')
        const gamepadRecognized = document.querySelector('#gamepadRecognized')
        const gamepadNotRecognized = document.querySelector('#gamepadNotRecognized')
        function startGamepadDetection(tableEngine) {
            if (tableEngine.inputWatcher) {
                setInterval(() => {
                    if (tableEngine.inputWatcher.gamepad.isRecognized()) {
                        gamepadIcon.classList.add('enabled')
                        gamepadDisabled.classList.add('hidden')
                        gamepadRecognized.classList.remove('hidden')
                        gamepadNotRecognized.classList.add('hidden')
                    } else if (tableEngine.inputWatcher.gamepad.isSomethingConnected()) {
                        gamepadIcon.classList.remove('enabled')
                        gamepadDisabled.classList.add('hidden')
                        gamepadRecognized.classList.add('hidden')
                        gamepadNotRecognized.classList.remove('hidden')
                    } else {
                        gamepadIcon.classList.remove('enabled')
                        gamepadDisabled.classList.remove('hidden')
                        gamepadRecognized.classList.add('hidden')
                        gamepadNotRecognized.classList.add('hidden')
                    }
                }, 200)
            }

        }

        // See https://gist.github.com/willywongi/5780151#file-2-index-html-L86
        function loadRemoteWebworker(webworkerUrl, callback) {
            return cacheFetch(webworkerUrl, {redirect: 'follow'})
            .then(function (resp) {
                return resp.text()
                .then(function (source) {
                    callback(window.URL.createObjectURL(new Blob([this.responseText])))
                })
            })
        }
        
        // Functions for loading/saving game progress
        function getStorage(gameId) {
            const storageStr = window.localStorage.getItem('puzzlescriptGameProgress')
            if (storageStr) {
                return JSON.parse(storageStr)[gameId]
            } else {
                return null
            }
        }
        function setStorage(gameId, levelNum) {
            const storageStr = window.localStorage.getItem('puzzlescriptGameProgress')
            const storage = storageStr ? JSON.parse(storageStr) : {}
            storage[gameId] = levelNum
            window.localStorage.setItem('puzzlescriptGameProgress', JSON.stringify(storage))
        }

        // Support toggling the "Enable CSS" checkbox
        const disableCss = document.querySelector('#disableCss')
        function setUi() {
            if (disableCss.checked) {
                table.classList.add('ps-ui-disabled')
            } else {
                table.classList.remove('ps-ui-disabled')
            }
            table.focus()
        }
        disableCss.addEventListener('change', setUi)
        setUi()

    // ]]></script>

    <script type="text/javascript">//<![CDATA[
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-48498113-1', 'philschatz.com');
        ga('send', 'pageview');
    // ]]></script>
</body>

</html>